# 03 - 产品定位与架构设计

> **核心问题**: DoraMate 在 DORA 生态中的定位是什么？它如何与 DORA 无缝集成？

---

## 🎯 3.1 产品定位

### DoraMate 是什么？

**DoraMate** 是一个面向具身智能开发者的**可视化低代码平台**，旨在：

- ✅ **降低技术门槛**: 无需手写 YAML 即可创建复杂数据流
- ✅ **提升开发效率**: 拖拽式节点编排、实时预览
- ✅ **增强可维护性**: 可视化数据流图、版本控制集成
- ✅ **保留技术深度**: 支持导出标准 YAML，与 DORA 生态完全兼容
- ✅ **工业级稳定性**: Rust 内存安全保证，7x24 无故障运行 ⭐
- ✅ **极致性能**: WebAssembly 零拷贝通信，媲美原生应用 ⭐
- ✅ **零配置**: 纯文件系统架构，无需数据库安装 ⭐

### 目标用户

1. **具身智能开发者** (主要)
   - 机器人应用开发
   - AI 模型集成
   - 计算机视觉应用

2. **AI 研究员** (次要)
   - 快速原型验证
   - 模型组合实验
   - 数据流优化

3. **技术学习者** (次要)
   - 学习 DORA 框架
   - 了解具身智能架构
   - 可视化编程入门

4. **工业软件开发商** (扩展) ⭐
   - 需要高性能、高稳定性解决方案
   - 7x24 无故障运行需求
   - 追求极致性能和零配置

### 产品价值主张

**对比传统 DORA 开发方式**:

| 功能 | 传统 DORA | DoraMate | 提升 |
|------|----------|----------|------|
| 数据流创建 | 手写 YAML | 拖拽节点 | 5x 效率 |
| 节点连接 | 手动配置 | 自动连线 | 10x 效率 |
| 错误排查 | 运行时报错 | 实时验证 | 3x 效率 |
| 学习曲线 | 陡峭 | 平缓 | -70% 时间 |
| 系统稳定性 | GC 停顿 | 无 GC | ⭐⭐⭐⭐⭐ |
| 配置复杂度 | 需要数据库 | 零配置 ⭐ | ⭐⭐⭐⭐⭐ |

---

## 🏗️ 3.2 系统架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    DoraMate 前端应用                         │
│                 (Leptos WebAssembly) ⭐                       │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  节点面板    │  │  画布区域    │  │  属性面板    │      │
│  │              │  │              │  │              │      │
│  │ - 输入节点   │  │ - 拖拽编排   │  │ - 节点配置   │      │
│  │ - 处理节点   │  │ - 连线管理   │  │ - 参数编辑   │      │
│  │ - 输出节点   │  │ - 缩放平移   │  │ - 环境变量   │      │
│  │ - 自定义节点 │  │ - 实时预览   │  │ - 验证提示   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                               │
│  ┌────────────────────────────────────────────────────┐     │
│  │  工具栏                                             │     │
│  │  [打开] [保存] [导入YAML] [导出] [本地运行⭐] [验证] │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                           ↕ HTTP/WebSocket (localhost:52100)
┌─────────────────────────────────────────────────────────────┐
│            DoraMate 本地代理服务 ⭐                           │
│                  (Axum 1.0 + Tokio)                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  HTTP API    │  │ 进程管理     │  │ 文件系统     │      │
│  │              │  │              │  │ 访问层       │      │
│  │ - /api/run   │  │ - Lifecycle  │  │ - 读写 YAML  │      │
│  │ - /api/stop  │  │ - Monitoring │  │ - 最近文件   │      │
│  │ - /api/health│  │ - Logs       │  │ - 配置管理   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                               │
│  系统托盘图标 | 自动启动 | 日志广播                             │
└─────────────────────────────────────────────────────────────┘
                           ↕ tokio::process + 文件 I/O
┌─────────────────────────────────────────────────────────────┐
│              本地文件系统 ⭐                                  │
│  ~/.doramate/                                                │
│  ├── dataflows/              # 数据流 YAML 文件              │
│  ├── cache/                  # 节点缓存                      │
│  ├── recent.json             # 最近文件列表                  │
│  └── config.toml             # 用户配置                      │
└─────────────────────────────────────────────────────────────┘
                           ↕ tokio::process::Command
┌─────────────────────────────────────────────────────────────┐
│                    DORA 核心生态                             │
│  [dora-cli] [dora-daemon] [dora-runtime] [节点 Hub]         │
└─────────────────────────────────────────────────────────────┘
```

**架构说明** ⭐:
- **本地执行模式**: 数据流在用户本地机器运行，避免硬件冲突
- **本地代理服务**: DoraMate LocalAgent 作为系统服务运行
- **纯文件系统**: 所有数据存储为文件，无需数据库 ⭐
- **直接硬件访问**: 完全访问本地硬件（摄像头、GPU、机器人）
- **隐私保护**: 视频流、敏感数据不离开本地机器
- **离线工作**: 无需互联网连接即可运行
- **Rust 优势**: 内存安全、高性能、WebAssembly 原生支持

### 核心功能模块

#### 1. 可视化节点编辑器

**节点面板**
- 从 dora-hub 获取节点列表
- 分类显示（输入/处理/输出）
- 搜索和过滤功能
- 自定义节点上传

**画布区域**
- 拖拽添加节点
- 贝塞尔曲线连线
- 缩放和平移
- 多选和批量操作
- 撤销/重做

**属性面板**
- 动态表单生成
- 实时验证反馈
- 环境变量编辑器
- 输入映射可视化

**工具栏**
- 打开/保存文件 ⭐
- 导入/导出 YAML
- 验证数据流
- 运行/停止
- 最近文件列表 ⭐

#### 2. YAML 导入导出引擎

**解析器** (YamlParser)
- 解析标准 DORA YAML
- 支持所有输入映射类型（User/Timer/External）
- 自动检测节点语言和类型

**生成器** (YamlGenerator)
- 从可视化图生成 YAML
- 优化格式和注释
- 保持与 DORA CLI 兼容

**验证器** (YamlValidator)
- 调用 dora-daemon 验证 API
- 实时错误提示
- 建议修复方案

#### 3. 自动布局算法

**层次化布局** (GraphLayoutService)
- 基于拓扑排序的分层
- 交叉最小化
- 自动计算节点位置

**用途**:
- YAML 导入后的自动布局
- 一键整理杂乱的画布

#### 4. 本地执行集成 ⭐ (Rust 版特性)

**DoraMate LocalAgent** (本地代理)
- 调用 `dora run` 运行数据流
- 调用 `dora build` 安装依赖
- 进程生命周期管理（启动/停止/监控）
- 实时日志收集和推送
- 硬件资源检测和冲突处理
- 系统托盘集成

**实时监控** (WebSockets)
- WebSocket 实时推送日志
- 节点状态更新
- 错误通知

#### 5. 文件系统管理 ⭐ (核心功能)

**文件操作**
- 打开/保存 YAML 文件
- 最近文件列表
- 文件夹浏览
- 拖拽打开文件
- 自动备份

**缓存管理**
- 节点元数据缓存 (JSON)
- 缩略图生成
- 缓存清理机制

**配置管理**
- 用户偏好设置 (TOML)
- 编辑器配置
- 主题设置

---

## 🔄 3.3 数据流设计

### 前端 → 本地代理 → DORA

```mermaid
graph LR
    A[前端可视化图] -->|HTTP POST| B[本地代理 API]
    B -->|转换为 YAML| C[YAML 生成器]
    C -->|保存文件| D[文件系统]
    D -->|dora run| E[DORA CLI]
    E -->|实时日志| F[WebSocket Hub]
    F -->|WebSocket| G[前端]
```

### 核心数据流

**创建数据流**:
1. 前端：拖拽节点、连线
2. 前端：调用本地保存 API
3. 本地代理：保存到文件系统 ⭐
4. 前端：显示保存成功

**导出 YAML**:
1. 前端：生成 YAML 内容
2. 前端：浏览器下载 YAML 文件
3. 用户：可用 `dora run` 直接运行

**运行数据流** ⭐ (本地执行):
1. 前端：调用本地代理 `/api/run`
2. 本地代理：生成 YAML 文件
3. 本地代理：启动 `dora run` 进程
4. 本地代理：通过 WebSocket 推送日志
5. 前端：实时显示日志

**打开数据流** ⭐ (文件系统):
1. 前端：调用本地代理 `/api/open`
2. 本地代理：从文件系统读取 YAML
3. 本地代理：反序列化为数据流对象
4. 前端：渲染可视化图
5. 本地代理：更新最近文件列表

---

## 🎨 3.4 UI/UX 设计原则

### 设计理念

**简单 > 复杂**
- 默认配置即可运行
- 高级选项可折叠
- 智能推荐节点连接

**可视化 > 文本**
- 节点状态用颜色表示
- 数据流向用箭头表示
- 错误用红色高亮

**即时反馈**
- 操作后立即响应
- 验证实时提示
- 动画过渡流畅

### 视觉设计

**配色方案**:
- 输入节点：蓝色 (#3B82F6)
- 处理节点：绿色 (#10B981)
- 输出节点：紫色 (#8B5CF6)
- 错误状态：红色 (#EF4444)

**节点卡片**:
- 圆角矩形 (8px)
- Material Design 阴影
- 悬停高亮效果

**连线**:
- 贝塞尔曲线
- 动态流动效果（运行时）
- 灰色（空闲）/ 蓝色（活跃）

---

## 🔐 3.5 技术架构选型

### 前端技术栈 ⭐ (Leptos WebAssembly)

| 组件 | 选型 | 理由 |
|-----|------|------|
| **框架** | Leptos 0.7 | 细粒度响应式、编译为 WASM、类似 React |
| **UI 库** | 自定义组件 | 基于工业需求定制、完全掌控 |
| **节点编辑器** | 自定义组件 (SVG/Canvas) | 高性能渲染、类型安全 |
| **状态管理** | Signals | Leptos 内置、细粒度更新 |
| **实时通信** | gloo-net | 异步 I/O、类型安全 |

### 后端技术栈 ⭐ (本地代理 - Axum)

| 组件 | 选型 | 理由 |
|-----|------|------|
| **框架** | Axum 1.0 | 基于 Tokio、极高性能、类型安全路由 |
| **异步运行时** | Tokio 1.x | 成熟稳定、性能卓越 |
| **文件 I/O** | tokio::fs + std::fs | 异步文件操作 ⭐ |
| **YAML 处理** | serde_yaml | 类型安全的序列化/反序列化 ⭐ |
| **验证** | Validator + Garde | 声明式验证 |
| **CQRS** | 自定义实现 | 基于 Trait 和泛型 |
| **实时通信** | Axum WS + tokio-tungstenite | 异步 WebSocket |

### 文件系统架构 ⭐ (核心优势)

**目录结构**:
```
~/.doramate/
├── dataflows/          # YAML 数据流文件
├── cache/              # 节点缓存
├── recent.json         # 最近文件列表
└── config.toml         # 用户配置
```

**优势**:
- ✅ 零配置：无需数据库安装、配置、维护
- ✅ 零依赖：减少 SeaORM、数据库驱动等复杂依赖
- ✅ 简化开发：专注核心功能，加速 MVP
- ✅ 易于备份：直接复制文件夹即可
- ✅ 符合 DORA 哲学：YAML 即配置

### 部署架构

**开发环境**:
```yaml
前端: Leptos WASM (localhost:3000)
本地代理: Axum (localhost:52100)
文件系统: ~/.doramate/
DORA: 本地安装
```

**生产环境** (桌面应用):
```yaml
前端: 嵌入式 WebAssembly
本地代理: 系统托盘服务
文件系统: ~/.doramate/
DORA: 用户本地环境
```

---

## 🚀 3.6 与 DORA 无缝集成

### 集成策略

**1. YAML 作为中间格式**
- DoraMate 可视化图 ↔ YAML ↔ DORA
- 保证与 DORA CLI 100% 兼容
- 支持手动编辑 YAML

**2. dora-cli 作为执行引擎**
- 不重新实现 DORA 的功能
- 复用现有的稳定工具
- 专注可视化编辑体验

**3. dora-hub 作为节点源**
- 自动同步节点元数据
- 显示节点文档和示例
- 一键安装节点

### 集成边界

**DoraMate 负责**:
- ✅ 可视化编辑
- ✅ YAML 生成
- ✅ 数据流验证
- ✅ 日志展示
- ✅ 文件系统管理 ⭐

**DORA 负责**:
- ✅ 数据流执行
- ✅ 节点调度
- ✅ 数据传输
- ✅ 性能优化

---

## 💡 3.7 MVP 功能范围

### v1.0 必须包含

- ✅ 可视化节点编辑器
- ✅ YAML 导入导出
- ✅ 基础验证功能
- ✅ 本地运行数据流（调用 dora-cli）⭐
- ✅ 实时日志查看
- ✅ 打开/保存数据流文件 ⭐
- ✅ 最近文件列表 ⭐
- ✅ 纯文件系统架构 ⭐

### v1.0 不包含（后续迭代）

- ❌ 实时数据预览（Arrow 数据）
- ❌ 节点性能监控
- ❌ AI 辅助节点推荐
- ❌ 多人协同编辑
- ❌ 云端部署管理

---

## 🎯 3.8 成功指标

### 功能完整性
- 支持至少 20 个常用 DORA 节点
- 导出的 YAML 可被 dora-cli 正确运行
- 支持所有输入映射类型（User/Timer/External）
- 文件系统稳定性：1000+ 次打开/保存无损坏 ⭐

### 性能指标
- 画布渲染: 50+ 节点流畅运行 (60fps)
- 首屏加载: < 2 秒 ⭐ (WASM 优势 + 无数据库初始化)
- YAML 导出: < 500ms
- 文件打开: < 100ms ⭐

### 稳定性指标 ⭐ (工业级)
- MTBF (平均故障间隔): > 720小时 (30天)
- MTTR (平均修复时间): < 5分钟
- 内存泄漏: 0 (Rust 保证)
- 可连续运行: > 6个月

### 用户体验
- 新手 5 分钟内创建第一个数据流
- 交互反馈延迟 < 100ms
- 错误提示准确率 > 95%

---

## 🚀 下一步

**继续阅读**：
- 📖 [04 - 技术栈选型](./04-技术栈选型.md) - 详细技术选型
- 🛠️ [05 - Leptos 前端架构](./05-Leptos前端架构.md) - 前端实现细节 ⭐
- 🛠️ [06 - Axum 后端架构](./06-Axum后端架构.md) - 本地代理实现 ⭐
- 📁 [07 - 文件系统架构](./07-文件系统架构.md) - 文件系统设计 ⭐
- 🎨 [10 - YAML 可视化功能](./10-YAML可视化功能.md) - ⭐ 核心功能

---

**文档作者**: 夏豪
**最后更新**: 2025-01-23
**版本**: v4.0 (Rust 全栈 + 纯文件系统)
**基于**: 00、01、02 章节内容 + 参考文档架构
