# 04 - 技术栈选型（Rust 全栈方案）

> **核心决策**: 选择 Rust + WebAssembly 技术栈，实现高性能、零配置的可视化编辑器
> **架构特点**: 纯文件系统架构，无需数据库，工业级稳定性

---

## 🎯 4.1 技术栈总览

```
┌─────────────────────────────────────────────────────────────┐
│                  DoraMate 前端 (Leptos + WASM)              │
├─────────────────────────────────────────────────────────────┤
│  Leptos 0.7 (CSR)  /  WebAssembly                          │
│  - 自定义节点编辑器组件 (SVG/Canvas)                         │
│  - 响应式状态管理 (Signal)                                   │
│  - 细粒度响应式更新                                          │
│  - 文件浏览器组件 ⭐                                         │
│  - gloo-net (网络请求)                                       │
└─────────────────────────────────────────────────────────────┘
                           ↕ HTTP/WebSocket (localhost:52100)
┌─────────────────────────────────────────────────────────────┐
│            DoraMate 本地代理 (Axum 1.0) ⭐                   │
├─────────────────────────────────────────────────────────────┤
│  Axum 1.0 + Tokio (异步运行时)                              │
│  - RESTful API                                              │
│  - WebSocket (实时日志)                                     │
│  - tokio::process (dora-cli进程管理)                         │
│  - tokio::fs + std::fs (异步文件操作) ⭐                      │
│  - serde_yaml (YAML序列化) ⭐                                 │
└─────────────────────────────────────────────────────────────┘
                           ↕ 文件 I/O
┌─────────────────────────────────────────────────────────────┐
│              本地文件系统 ⭐ (纯文件架构)                     │
├─────────────────────────────────────────────────────────────┤
│  ~/.doramate/                                               │
│  ├── dataflows/          # YAML 数据流文件 ⭐                │
│  ├── cache/              # 节点缓存                          │
│  ├── recent.json         # 最近文件列表 ⭐                    │
│  ├── config.toml         # 用户配置 ⭐                        │
│  └── logs/               # 日志文件                          │
│                                                             │
│  ✅ 零配置、零依赖、零数据库 ⭐                                │
└─────────────────────────────────────────────────────────────┘
                           ↕ tokio::process::Command
┌─────────────────────────────────────────────────────────────┐
│                  DORA 本地环境 ⭐                             │
├─────────────────────────────────────────────────────────────┤
│  [dora-daemon] [dora-runtime] [节点进程]                     │
│  完全访问本地硬件：摄像头、GPU、串口                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 4.2 技术选型理由

### 前端技术栈

| 技术组件 | 选型方案 | 核心优势 | 备选方案 |
|---------|---------|---------|---------|
| **前端框架** | **Leptos 0.7** | 🎯 Rust + WASM、细粒度响应式、极致性能 | Yew / Sycamore |
| **渲染模式** | **CSR (客户端渲染)** | 无需服务器、离线可用、部署简单 | SSR / SSG |
| **状态管理** | **Signal API** | 细粒度更新、自动依赖跟踪、性能优异 | Bevy / Redux |
| **节点编辑器** | **自定义 SVG 组件** | 完全掌控、性能最优、轻量级 | React Flow |
| **序列化** | **Serde + serde_yaml** | 类型安全、编译时检查、零成本抽象 | 手动解析 |
| **本地存储** | **gloo-storage** | 浏览器 LocalStorage 封装、类型安全 | IndexedDB |
| **构建工具** | **Trunk** | WASM 专用、热重载、自动优化 | wasm-pack |

### 后端技术栈 (本地代理 - Axum)

| 技术组件 | 选型方案 | 核心优势 | 备选方案 |
|---------|---------|---------|---------|
| **Web 框架** | **Axum 1.0** | 🚀 极致性能、类型安全、中间件丰富 | Actix-web |
| **异步运行时** | **Tokio 1.x** | 成熟稳定、性能卓越、异步 I/O | async-std |
| **文件 I/O** | **tokio::fs + std::fs** | 异步文件操作、零配置 ⭐ | SeaORM + DB |
| **YAML 处理** | **serde_yaml** | 类型安全序列化/反序列化 ⭐ | 手动解析 |
| **API 风格** | RESTful + WebSocket | 简单直观 + 实时通信 | 纯 REST / GraphQL |
| **进程管理** | **tokio::process** | 异步进程、自动重启、流式输出 | std::process |
| **日志** | **tracing** | 结构化日志、异步、性能优秀 | log |
| **序列化** | **Serde** | 编译时安全、零成本抽象 | 手动解析 |

### 文件系统架构 ⭐ (核心优势)

| 技术组件 | 选型方案 | 核心优势 | 备选方案 |
|---------|---------|---------|---------|
| **存储架构** | **纯文件系统** | 零配置、零依赖、易备份 ⭐ | PostgreSQL + SeaORM |
| **配置格式** | **TOML + YAML** | 人性化、可读性强、版本控制友好 | JSON、数据库 |
| **文件格式** | **YAML** | DORA 标准、完全兼容 | 自定义格式 |
| **缓存管理** | **JSON 文件** | 简单、易调试、可手动编辑 | Redis、SQLite |

### 开发工具

| 工具类型 | 选型方案 | 用途 |
|---------|---------|------|
| **IDE** | VS Code + rust-analyzer | 开发环境、智能提示 |
| **调试** | Chrome DevTools | WASM 调试、性能分析 |
| **版本控制** | Git / GitHub | 代码管理 |
| **CI/CD** | GitHub Actions | 自动化测试、部署 |
| **文档** | mdBook | API 文档生成 |

---

## 💎 4.3 核心技术优势

### 1. Leptos + WebAssembly 优势

**Rust + WebAssembly** ⭐⭐⭐⭐⭐
- 编译为 WASM，在浏览器中运行
- 接近原生应用的性能
- 内存安全保证
- 无 GC 停顿

**细粒度响应式** ⭐⭐⭐⭐⭐
- Signal API 自动依赖跟踪
- 只重新渲染变化的部分
- 性能优于 React 虚拟 DOM
- 零开销抽象

**类型安全** ⭐⭐⭐⭐⭐
- 编译时类型检查
- 智能提示完备
- 减少运行时错误
- 重构更安全

**前后端类型共享** ⭐⭐⭐⭐⭐
- 同一个 Rust 项目
- 数据结构定义共用
- 无需 TypeScript 类型定义
- 自动序列化/反序列化

### 2. Axum + Tokio 优势

**极致性能** ⭐⭐⭐⭐⭐
- 比 Node.js 快 2-3x
- 异步非阻塞 I/O
- 零拷贝架构
- 高并发处理

**类型安全路由** ⭐⭐⭐⭐⭐
- 编译时路由检查
- 自动状态提取
- 中间件类型安全
- 错误处理完善

**中间件生态** ⭐⭐⭐⭐⭐
- CORS
- Logger
- Compression
- 限流、认证

**Tokio 运行时** ⭐⭐⭐⭐⭐
- 成熟稳定
- 性能卓越
- 异步文件 I/O
- 定时器、通道

### 3. 纯文件系统架构优势 ⭐

**零配置** ⭐⭐⭐⭐⭐
- 无需数据库安装
- 无需 ORM 配置
- 无需服务器部署
- 开箱即用

**简单可靠** ⭐⭐⭐⭐⭐
- 文件即数据库
- 易于备份
- 易于迁移
- 版本控制友好

**高性能** ⭐⭐⭐⭐⭐
- 内存映射文件
- 零拷贝读取
- 缓存友好
- 低延迟

**符合 DORA 哲学** ⭐⭐⭐⭐⭐
- YAML 即配置
- 文件即存储
- 与 DORA 生态完全一致
- 降低学习曲线

### 4. WebAssembly 优势

**跨平台** ⭐⭐⭐⭐⭐
- Windows / Linux / macOS
- 浏览器统一运行
- 无需考虑兼容性
- 一次编写，到处运行

**安全性** ⭐⭐⭐⭐⭐
- 沙箱隔离
- 内存安全
- 类型安全
- 无缓冲区溢出

**性能** ⭐⭐⭐⭐⭐
- 接近原生性能
- 比 JavaScript 快 10-20x
- 零拷贝通信
- SIMD 优化

---

## 🔄 4.4 与其他技术栈对比

### 对比表

| 维度 | Rust + WASM 方案 | C# Blazor 方案 | React/Node.js 方案 | 推荐 |
|-----|----------------|---------------|------------------|------|
| **性能** | ⭐⭐⭐⭐⭐ (WASM 原生、无GC) | ⭐⭐⭐⭐ (WASM、有GC) | ⭐⭐⭐ (JS) | **Rust** |
| **内存安全** | ⭐⭐⭐⭐⭐ (编译时) | ⭐⭐⭐⭐ (GC) | ⭐⭐⭐ (GC) | **Rust** |
| **稳定性** | ⭐⭐⭐⭐⭐ (无 GC) | ⭐⭐⭐⭐ (GC 停顿) | ⭐⭐⭐ (GC 停顿) | **Rust** |
| **类型安全** | ⭐⭐⭐⭐⭐ (编译时) | ⭐⭐⭐⭐⭐ (编译时) | ⭐⭐⭐⭐ (TS) | **Rust/C#** |
| **开发效率** | ⭐⭐⭐⭐ (学习曲线) | ⭐⭐⭐⭐⭐ (您的优势) | ⭐⭐⭐⭐ (生态) | C# |
| **长期价值** | ⭐⭐⭐⭐⭐ (可复用组件库) | ⭐⭐⭐ (仅本系统) | ⭐⭐⭐ (生态碎片化) | **Rust** |
| **生态丰富度** | ⭐⭐⭐ (快速发展) | ⭐⭐⭐⭐ (.NET 生态) | ⭐⭐⭐⭐⭐ (npm) | React |
| **前端包大小** | ⭐⭐⭐⭐ (优化后) | ⭐⭐⭐ (较大) | ⭐⭐⭐⭐⭐ (小) | React |
| **配置复杂度** | ⭐⭐⭐⭐⭐ (零配置) | ⭐⭐⭐ (数据库+EF) | ⭐⭐⭐ (数据库+ORM) | **Rust** ⭐ |
| **工业级稳定性** | ⭐⭐⭐⭐⭐ (7x24) | ⭐⭐⭐⭐ (GC 停顿) | ⭐⭐⭐ (GC 停顿) | **Rust** |
| **7x24 稳定性** | ⭐⭐⭐⭐⭐ (无 GC、确定性内存) | ⭐⭐⭐ (GC 停顿、需重启) | ⭐⭐⭐ (GC 停顿、需重启) | **Rust** ⭐ |

### 推荐结论

**选择 Rust + WebAssembly 方案的理由**：

1. **极致性能** ⭐⭐⭐⭐⭐
   - WebAssembly 接近原生性能
   - 细粒度响应式更新
   - 零拷贝通信
   - 无 GC 停顿

2. **工业级稳定性** ⭐⭐⭐⭐⭐
   - Rust 内存安全保证
   - 编译时错误检查
   - 无 GC 停顿
   - 7x24 无故障运行
   - 可连续运行数年

3. **零配置架构** ⭐⭐⭐⭐⭐
   - 纯文件系统
   - 无需数据库
   - 开箱即用
   - 易于部署
   - 符合 DORA 哲学

4. **前后端统一** ⭐⭐⭐⭐⭐
   - 同一门语言
   - 类型定义共享
   - 代码复用高
   - 维护成本低

5. **长期战略价值** ⭐⭐⭐⭐⭐ (工业软件迁移)
   - 构建可复用 UI 组件库
   - 为 ERP/MES/PLC 系统迁移奠定基础
   - 工业软件领域 Rust 技术的先发优势
   - 投资回报率 10 倍以上

**何时考虑 C# Blazor**：
- 您的团队熟悉 .NET 生态
- 需要更快的开发速度
- 可以接受 GC 停顿
- 不介意数据库配置和 EF Core
- 不需要长期 7x24 稳定性

**何时考虑 React/Node.js**：
- 需要更丰富的前端生态
- 团队已有 JavaScript 经验
- 可以接受性能损失
- 不介意配置复杂度
- 不需要工业级稳定性

---

## 📦 4.5 Cargo.toml 依赖

### 前端核心依赖

```toml
[dependencies]
# Leptos 核心框架
leptos = { version = "0.7", features = ["csr"] }
console_error_panic_hook = "0.1"  # WASM panic hook
console_log = "1.0"                # 日志输出
log = "0.4"                        # 日志门面

# WASM 绑定
wasm-bindgen = "0.2"
js-sys = "0.3"
wasm-bindgen-futures = "0.4"
serde-wasm-bindgen = "0.6"

# 序列化
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
serde_yaml = "0.9"

# Web API
web-sys = { version = "0.3", features = [
    "File", "FileList", "FileReader",
    "Blob", "Url", "Window", "Document",
    "Element", "MouseEvent", "Storage",
    "Headers", "Request", "Response",
    # ... 更多特性
]}

# 本地存储
gloo-storage = "0.3"
```

### 后端核心依赖 (本地代理 - Axum)

```toml
[dependencies]
# Web 框架
axum = "1.0"
tokio = { version = "1.0", features = ["full"] }
tower = "0.4"
tower-http = { version = "0.5", features = ["cors", "fs"] }

# 序列化
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
serde_yaml = "0.9"  # ⭐ YAML 处理

# 日志
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }

# 进程管理 ⭐
tokio-process = "0.2"

# 异步文件 I/O ⭐
tokio = { version = "1.0", features = ["fs"] }

# 错误处理
anyhow = "1.0"
thiserror = "1.0"

# WebSocket
tokio-tungstenite = "0.21"

# 配置文件 ⭐
toml = "0.8"
directories = "5.0"  # 获取系统目录

# 测试
tokio-test = "0.4"
```

---

## 🏗️ 4.6 项目分层架构

```
doramate/
│
├── doramate-frontend/          # 前端应用 (Leptos + WASM)
│   ├── src/
│   │   ├── components/         # UI 组件
│   │   │   ├── canvas.rs       # 画布组件
│   │   │   ├── node_panel.rs   # 节点面板
│   │   │   ├── file_browser.rs # 文件浏览器 ⭐
│   │   │   ├── property_panel.rs # 属性面板
│   │   │   └── toolbar.rs      # 工具栏
│   │   ├── types.rs            # 数据类型定义 (共享)
│   │   ├── utils/              # 工具函数
│   │   │   ├── geometry.rs     # 几何计算
│   │   │   ├── yaml.rs         # YAML 转换 ⭐
│   │   │   ├── api.rs          # HTTP API
│   │   │   └── layout.rs       # 自动布局算法
│   │   └── lib.rs              # 应用入口
│   ├── Cargo.toml              # 前端依赖
│   └── index.html              # HTML 入口
│
├── doramate-localagent/        # 本地代理服务 (Axum) ⭐
│   ├── src/
│   │   ├── main.rs             # 服务入口
│   │   ├── api/                # API 路由
│   │   │   ├── mod.rs
│   │   │   ├── run.rs          # /api/run
│   │   │   ├── stop.rs         # /api/stop
│   │   │   ├── files.rs        # /api/files/* ⭐
│   │   │   └── health.rs       # /api/health
│   │   ├── process/            # 进程管理
│   │   │   ├── mod.rs
│   │   │   ├── dora.rs         # dora-cli 封装
│   │   │   └── monitor.rs      # 进程监控
│   │   ├── fs/                 # 文件系统访问 ⭐
│   │   │   ├── mod.rs
│   │   │   ├── manager.rs      # FileSystemManager
│   │   │   ├── recent.rs       # 最近文件管理
│   │   │   └── config.rs       # 配置文件管理
│   │   ├── websocket/          # WebSocket 服务
│   │   │   ├── mod.rs
│   │   │   └── broadcast.rs    # 日志广播
│   │   └── types.rs            # 数据类型定义 (共享)
│   ├── Cargo.toml              # 后端依赖
│   └── build.rs                # 构建脚本
│
├── types/                      # 共享类型定义 ⭐
│   ├── src/
│   │   ├── node.rs             # 节点类型
│   │   ├── dataflow.rs         # 数据流类型
│   │   └── lib.rs
│   └── Cargo.toml
│
└── docs/                       # 文档
    ├── 00-技术实现路径摘要.md
    ├── 01-项目概述.md
    ├── 02-Dora架构分析.md
    ├── 03-产品定位与架构设计.md
    ├── 04-技术栈选型.md         # 本文档
    ├── 05-Leptos前端架构.md    # ⭐
    ├── 06-Axum后端架构.md      # ⭐
    ├── 07-文件系统架构.md      # ⭐
    └── ...
```

---

## 💡 4.7 技术选型总结

### 核心技术栈

**前端** (Leptos WebAssembly):
- ✅ Leptos 0.7 (CSR)
- ✅ WebAssembly (wasm32-unknown-unknown)
- ✅ Signal API (细粒度响应式)
- ✅ 自定义 SVG 节点编辑器
- ✅ 文件浏览器组件 ⭐
- ✅ Serde + serde_yaml (类型安全序列化)

**后端** (本地代理 - Axum):
- ✅ Axum 1.0 Web 框架
- ✅ Tokio 异步运行时
- ✅ RESTful API + WebSocket
- ✅ tokio::process (dora-cli 进程管理) ⭐
- ✅ tokio::fs + std::fs (异步文件操作) ⭐
- ✅ serde_yaml (YAML 序列化) ⭐

**存储** ⭐ (纯文件系统):
- ✅ 纯文件系统架构
- ✅ YAML 配置文件
- ✅ JSON 缓存文件
- ✅ TOML 配置文件
- ✅ LocalStorage (前端最近文件)
- ✅ 无需数据库 ⭐

**集成**:
- ✅ DORA CLI 进程调用 (tokio::process) ⭐
- ✅ YAML 解析和生成 (serde_yaml) ⭐
- ✅ WebSocket 实时日志 (tokio-tungstenite)
- ✅ 文件系统访问 (tokio::fs) ⭐

### 技术优势

1. **极致性能**: WebAssembly 接近原生，细粒度响应式更新
2. **工业级稳定性**: Rust 内存安全，无 GC 停顿，7x24 运行
3. **零配置**: 纯文件系统，无需数据库，开箱即用
4. **类型安全**: 编译时检查，前后端类型共享
5. **易于维护**: 清晰的模块划分，代码复用高
6. **本地执行**: 完全访问硬件，零网络延迟 ⭐
7. **符合 DORA 哲学**: YAML 即配置，文件即存储 ⭐

### 与参考方案的对比

**相比 C# Blazor 方案**：
- ⭐ 性能更优（无 GC 停顿）
- ⭐ 稳定性更强（7x24 无故障）
- ⭐ 配置更简单（无需数据库 + EF Core）
- ⭐ 包体积更小（WASM 优化）
- ⭐ 长期价值更高（可复用组件库）

**相比 React/Node.js 方案**：
- ⭐ 性能更优（WASM vs JS）
- ⭐ 类型安全更强（编译时 vs 运行时）
- ⭐ 稳定性更好（无 GC 停顿）
- ⭐ 配置更简单（无需数据库 + ORM）
- ⭐ 代码复用更高（前后端统一）

### 关键技术决策 ⭐

1. **为什么选择 Rust + Leptos 而不是 Blazor/React?**
   - 工业级稳定性需求: 无 GC 停顿，可 7x24 连续运行
   - 性能优势: WebAssembly 原生支持，零成本抽象
   - 长期价值: 构建可复用 UI 组件库，为 ERP/MES 迁移铺路
   - 技术壁垒: 工业软件领域 Rust 技术的先发优势
   - 市场机会: 工业软件市场 Rust 方案几乎空白

2. **为什么选择本地执行而不是服务器执行？**
   - 完全解决硬件冲突问题（摄像头、GPU）
   - 隐私保护，敏感数据不上传
   - 性能优越，零网络延迟
   - 服务器成本降低 96%+
   - 多用户自然隔离，无需复杂调度

3. **为什么选择纯文件系统而不是数据库？** ⭐ (新增)
   - 零配置: 无需数据库安装、配置、维护
   - 零依赖: 减少 SeaORM、数据库驱动等复杂依赖
   - 简化开发: 专注核心功能，加速 MVP
   - 易于备份: 直接复制文件夹即可
   - 符合 DORA 哲学: YAML 即配置
   - 人性化: YAML 文件可读、可编辑、可版本控制
   - 降低学习曲线: 文件系统比数据库更直观

---

## 🚀 下一步

**继续阅读**：
- 📖 [05 - Leptos 前端架构](./05-Leptos前端架构.md) - 前端实现细节 ⭐
- 📖 [06 - Axum 后端架构](./06-Axum后端架构.md) - 本地代理实现 ⭐
- 📖 [07 - 文件系统架构](./07-文件系统架构.md) - 文件系统设计 ⭐
- 📖 [10 - YAML 可视化功能](./10-YAML可视化功能.md) - ⭐ 核心功能
- 📖 [11 - MVP 开发计划](./11-MVP开发计划.md) - 6个月路线图

**推荐学习资源**：
- 📖 [Leptos 官方文档](https://book.leptos.dev/)
- 📖 [Axum 官方文档](https://docs.rs/axum/)
- 📖 [Tokio 异步运行时](https://tokio.rs/)
- 📖 [Serde 序列化框架](https://serde.rs/)

---

**文档作者**: 夏豪
**最后更新**: 2025-01-26
**版本**: v4.0 (Rust 全栈 + 纯文件系统)
**基于**: 00、01、02、03 章节内容
