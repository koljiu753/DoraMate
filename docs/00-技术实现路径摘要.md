# 00 - Rust 版DoraMate 技术实现路径摘要 

> 基于完整技术实现路径分析的精炼摘要 - 全 Rust 技术栈实现
> 适用于工业软件领域，追求极致性能与7x24稳定性
> **纯文件系统架构 - 零数据库设计**

---

## 📋 目录

1. [项目概述](#项目概述)
2. [DORA架构核心要点](#dora架构核心要点)
3. [系统架构设计](#系统架构设计)
4. [技术栈选型](#技术栈选型)
5. [核心功能模块](#核心功能模块)
6. [数据存储架构](#数据存储架构-)
7. [用户操作业务流程](#用户操作业务流程)
8. [开发计划概览](#开发计划概览)
9. [验收标准](#验收标准)

---

## 项目概述

### 产品定位

**DoraMate** 是面向具身智能开发者的可视化低代码平台，旨在降低 DORA 框架的使用门槛。

**核心价值**:
- ✅ 降低技术门槛: 无需手写 YAML 配置
- ✅ 提升开发效率: 拖拽式节点编排、实时预览
- ✅ 增强可维护性: 可视化数据流图、版本控制集成
- ✅ 保留技术深度: 完全兼容 DORA 生态
- ✅ 工业级稳定性: Rust 内存安全，7x24 无故障运行
- ✅ 极致性能: WebAssembly 零拷贝通信，媲美原生应用
- ✅ 零配置: 纯文件系统，无需数据库安装和维护 ⭐

### 目标用户

1. **具身智能开发者** (主要) - 机器人应用、AI 模型集成
2. **AI 研究员** (次要) - 快速原型验证、模型组合实验
3. **技术学习者** (次要) - 学习 DORA 框架、可视化编程入门
4. **工业软件开发商** (扩展) - 需要高性能、高稳定性解决方案

### 为什么需要 Rust + 纯文件系统实现

**DORA 框架优势**:
- 极致性能: 相比 ROS2 有 10-17x 的性能提升
- 零拷贝通信: 使用 Apache Arrow 格式
- 多语言支持: Python、Rust、C、C++、C#
- 2025年生态爆发: 大量新增 AI 模型节点

**但存在痛点**:
- ❌ 需要手写 YAML 配置文件
- ❌ 节点间连接关系不直观
- ❌ 缺少可视化调试工具
- ❌ 新手学习曲线陡峭

**Rust 技术栈的独特价值** ⭐:
- ✅ **工业级稳定性**: 无 GC 停顿，可连续运行数年
- ✅ **内存安全**: 编译时保证，无运行时恐慌
- ✅ **极致性能**: 零成本抽象，媲美 C/C++
- ✅ **可复用组件库**: 为后续迁移 ERP/MES/PLC 系统奠定基础
- ✅ **全栈统一**: 前后端统一语言，代码复用最大化
- ✅ **WebAssembly 原生**: 编译目标之一，性能最优

**纯文件系统架构优势** ⭐:
- ✅ **零配置**: 无需数据库安装、配置、维护
- ✅ **零依赖**: 减少 SeaORM、数据库驱动等依赖
- ✅ **简化开发**: 专注于核心功能，加速 MVP 开发
- ✅ **隐私保护**: 数据完全本地化，文件系统直接访问
- ✅ **易于备份**: 直接复制文件夹即可备份
- ✅ **符合 DORA 哲学**: YAML 即配置，文件即存储

---

## DORA架构核心要点

### 核心架构特点

**数据流范式**:
- 声明式配置: 通过 YAML 文件定义数据流
- 节点隔离: 每个节点作为独立进程运行
- 输入输出映射: 节点间通过输入输出进行数据传递
- 定时器支持: 内置 `dora/timer/millis/{interval}` 定时器

**通信机制**:
- **本地通信**: 共享内存（零拷贝）- 极致性能
- **分布式通信**: Zenoh 协议（2025年新增）
- **消息格式**: Apache Arrow - 跨语言零拷贝数据交换
- **遥测**: OpenTelemetry 支持

**核心组件**:
- `dora-core`: 核心库 - 数据流描述符、配置解析
- `dora-message`: 消息类型 - 独立版本控制（当前 0.6.0）
- `dora-cli`: 命令行工具 - 构建和运行数据流
- `dora-daemon`: 守护进程 - 共享内存管理、节点协调
- `dora-runtime`: 运行时 - 单个节点执行环境

**实验性组件**:
- `dora-coordinator`: 基于进程/库的替代实现原型（非生产环境使用）

### 2025年重要更新

- 2025/08: `dora.builder` Python API - 命令式数据流定义
- 2025/03: Python 异步 API 支持、Zenoh 分布式数据流
- 2025/02-05: 大量 AI 模型节点（Qwen2.5、SAM2、Phi4、Mediapipe 等）

---

## 系统架构设计

### 整体系统架构图 ⭐ (本地执行模式 - Rust 版 + 纯文件系统)

```
┌─────────────────────────────────────────────────────────────┐
│                    DoraMate 前端应用                         │
│                 (Leptos WebAssembly) ⭐                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  节点面板    │  │  画布区域    │  │  属性面板    │      │
│  │              │  │              │  │              │      │
│  │ - 输入节点   │  │ - 拖拽编排   │  │ - 节点配置   │      │
│  │ - 处理节点   │  │ - 连线管理   │  │ - 参数编辑   │      │
│  │ - 输出节点   │  │ - 缩放平移   │  │ - 环境变量   │      │
│  │ - 自定义节点 │  │ - 实时预览   │  │ - 验证提示   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                               │
│  ┌────────────────────────────────────────────────────┐     │
│  │  工具栏                                             │     │
│  │  [打开] [保存] [导入YAML] [导出] [本地运行⭐] [验证] │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                           ↕ HTTP (localhost:52100) ⭐
┌─────────────────────────────────────────────────────────────┐
│            DoraMate LocalAgent (本地代理服务) ⭐              │
│                  (Axum 1.0 + Tokio) ⭐                        │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  HTTP API    │  │ 进程管理     │  │ 文件系统     │      │
│  │              │  │              │  │ 访问层       │      │
│  │ - /api/run   │  │ - Lifecycle  │  │ - 读写 YAML  │      │
│  │ - /api/stop  │  │ - Monitoring │  │ - 最近文件   │      │
│  │ - /api/health│  │ - Logs       │  │ - 配置管理   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                               │
│  系统托盘图标 | 自动启动 | 日志广播                             │
└─────────────────────────────────────────────────────────────┘
                           ↕ tokio::process::Command + 文件 I/O
┌─────────────────────────────────────────────────────────────┐
│              本地文件系统 ⭐                                  │
│  ~/.doramate/                                               │
│  ├── dataflows/              # 数据流 YAML 文件             │
│  │   ├── my-camera-flow.yml                                 │
│  │   ├── yolo-detection.yml                                  │
│  │   └── sam2-segmentation.yml                               │
│  ├── cache/                  # 缓存文件                     │
│  │   ├── nodes.json          # 节点元数据缓存               │
│  │   └── thumbnails/         # 缩略图缓存                   │
│  ├── recent.json             # 最近打开文件列表             │
│  ├── config.toml             # 用户配置                     │
│  └── logs/                   # 日志文件                     │
└─────────────────────────────────────────────────────────────┘
                           ↕ tokio::process::Command
┌─────────────────────────────────────────────────────────────┐
│                    DORA 本地环境 ⭐                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ dora-daemon  │  │ dora-runtime │  │  节点进程    │      │
│  │ (守护进程)   │  │ (运行时)     │  │              │      │
│  └──────────────┘  └──────────────┘  ├─ camera      │      │
│                                         ├─ yolo        │      │
│                                         └─ sam2        │      │
└─────────────────────────────────────────────────────────────┘
                           ↕ 硬件访问
┌─────────────────────────────────────────────────────────────┐
│                    本地硬件资源 ⭐                             │
│  [/dev/video0] [/dev/audio] [GPU] [串口/USB]                │
└─────────────────────────────────────────────────────────────┘

↕ HTTP/WebSocket (可选，用于云端数据同步)
┌─────────────────────────────────────────────────────────────┐
│              DoraMate 云端服务 (可选)                         │
│  - 数据流云端存储  - 模板库  - 社区分享                       │
└─────────────────────────────────────────────────────────────┘
```

**架构说明** ⭐:
- **本地执行**: 数据流在用户本地机器运行，避免硬件冲突
- **本地代理**: DoraMate LocalAgent 作为系统服务运行
- **纯文件系统**: 所有数据存储为文件，无需数据库 ⭐
- **直接访问**: 完全访问本地硬件（摄像头、GPU、机器人）
- **隐私保护**: 视频流、敏感数据不离开本地机器
- **离线工作**: 无需互联网连接即可运行
- **Rust 优势**: 内存安全、高性能、WebAssembly 原生支持

### Clean Architecture 分层架构 (Rust 版 + 文件系统)

```
┌─────────────────────────────────────┐
│      Presentation Layer             │
│  (Leptos Components, Handlers)      │
│  - 视图组件                          │
│  - 事件处理器                        │
│  - DTO 转换                          │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      Application Layer              │
│  (Use Cases, Services)              │
│  - 业务用例                          │
│  - 输入端口 (Input Ports)            │
│  - 输出端口 (Output Ports)           │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      Domain Layer                   │
│  (Entities, Traits)                 │
│  - 领域实体                          │
│  - 业务规则                          │
│  - Trait 定义                        │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      Infrastructure Layer           │
│  (File System, External Services)   │
│  - 文件系统访问 ⭐                    │
│  - YAML 序列化/反序列化              │
│  - DORA CLI 调用                    │
└─────────────────────────────────────┘
```

---

## 技术栈选型

### 全 Rust 技术栈 ⭐ (简化版 - 无数据库)

**前端技术栈** (WebAssembly):
| 技术组件 | 选型 | 核心优势 |
|---------|------|---------|
| 前端框架 | **Leptos 0.7** | 细粒度响应式、类似 React、编译为 WASM |
| UI 组件库 | **自定义组件** | 基于工业需求定制、完全掌控 |
| 节点编辑器 | **自定义组件 (SVG/Canvas)** | 高性能渲染、类型安全 |
| 状态管理 | **Signals** | Leptos 内置、细粒度更新 |
| 实时通信 | **WebSockets + gloo-net** | 异步 I/O、类型安全 |
| 构建工具 | **Trunk** | WASM 打包、热重载 |

**后端技术栈** (本地代理):
| 技术组件 | 选型 | 核心优势 |
|---------|------|---------|
| 后端框架 | **Axum 1.0** | 基于 Tokio、极高性能、类型安全路由 |
| 异步运行时 | **Tokio 1.x** | 成熟稳定、性能卓越 |
| 文件 I/O | **tokio::fs** | 异步文件操作 |
| YAML 处理 | **serde_yaml** | 类型安全的序列化/反序列化 |
| 验证 | **Validator + Garde** | 声明式验证 |
| CQRS | **自定义实现** | 基于 Trait 和泛型 |
| 实时通信 | **Axum WS + tokio-tungstenite** | 异步 WebSocket |

**本地代理技术栈** ⭐:
| 技术组件 | 选型 | 用途 |
|---------|------|------|
| 本地服务 | **Axum 1.0** | 监听 localhost:52100 |
| 进程管理 | **tokio::process** | 异步启动/停止 dora 进程 |
| 文件系统 | **tokio::fs + std::fs** | 异步文件操作 ⭐ |
| 平台集成 | **系统服务/启动项** | Windows/macOS/Linux 托盘运行 |
| 安装打包 | **Cargo-binstall / Inno Setup** | 跨平台分发 |

**工业级 UI 组件库** ⭐ (复用资产):
| 组件类型 | 技术实现 | 应用场景 |
|---------|---------|---------|
| 数据表格 | **虚拟滚动 + Signals** | 10万+ 行流畅渲染 |
| 表单系统 | **动态组件 + 验证** | 节点配置、参数编辑 |
| 图表组件 | **Plotters + Canvas** | 实时数据可视化 |
| 树形控件 | **递归组件** | 节点层级展示 |
| 属性面板 | **反射 + 宏** | 动态属性编辑 |
| 标签编辑器 | **自定义交互** | 多标签管理 |
| 文件浏览器 | **自定义组件** | 打开/保存文件 ⭐ |

**与 Blazor/C# 方案对比**:

| 维度 | Rust 全栈方案 | Blazor/C# 方案 | 推荐 |
|-----|--------------|---------------|------|
| 性能 | ⭐⭐⭐⭐⭐ (WASM 原生、无GC) | ⭐⭐⭐⭐ (WASM、有GC) | **Rust** |
| 稳定性 | ⭐⭐⭐⭐⭐ (内存安全、无停顿) | ⭐⭐⭐⭐ (GC停顿、内存泄漏风险) | **Rust** |
| 类型安全 | ⭐⭐⭐⭐⭐ (编译时保证) | ⭐⭐⭐⭐⭐ (编译时保证) | 平手 |
| 学习曲线 | ⭐⭐⭐ (需学习 Rust/Leptos) | ⭐⭐⭐⭐⭐ (您已掌握 C#) | **C#** |
| 长期价值 | ⭐⭐⭐⭐⭐ (可复用组件库) | ⭐⭐⭐ (仅本系统) | **Rust** |
| 7x24 稳定性 | ⭐⭐⭐⭐⭐ (无 GC、确定性内存) | ⭐⭐⭐ (GC 停顿、需重启) | **Rust** |
| 简化程度 | ⭐⭐⭐⭐⭐ (零数据库、纯文件) | ⭐⭐⭐⭐ (需要 EF Core + SQL) | **Rust** ⭐ |

**选择 Rust 全栈 + 纯文件系统方案的理由**:
1. **工业级稳定性** - 无 GC 停顿，可连续运行数年
2. **性能优越** - WebAssembly 原生支持，零成本抽象
3. **长期价值** - 构建可复用 UI 组件库，为 ERP/MES/PLC 系统迁移铺路
4. **技术壁垒** - 工业软件领域 Rust 技术的先发优势
5. **市场机会** - 工业软件市场 Rust 方案几乎空白
6. **简化开发** - 零数据库配置，专注核心功能 ⭐
7. **零依赖** - 减少 ORM、数据库驱动等复杂依赖 ⭐

---

## 核心功能模块

### 1. 可视化节点编辑器

**节点面板**:
- 从 dora-hub 获取节点列表
- 分类显示（输入/处理/输出）
- 搜索和过滤功能
- 自定义节点上传

**画布区域**:
- 拖拽添加节点
- 贝塞尔曲线连线
- 缩放和平移
- 多选和批量操作
- 撤销/重做

**属性面板**:
- 动态表单生成
- 实时验证反馈
- 环境变量编辑器
- 输入映射可视化

**工具栏**:
- 打开/保存文件 ⭐
- 导入/导出 YAML
- 验证数据流
- 运行/停止
- 最近文件列表 ⭐

### 2. YAML 导入导出引擎 ⭐ 独有功能

**解析器特性**:
- 完整解析标准 DORA YAML
- 支持所有输入映射类型（User/Timer/External）
- 自动检测节点语言和类型
- 错误提示与修复建议

**生成器特性**:
- 从可视化图生成 YAML
- 优化格式和注释
- 保持与 DORA CLI 100% 兼容

**自动布局算法**:
- 基于拓扑排序的层次化布局
- 交叉最小化算法
- 自动计算节点位置

### 3. 本地执行层 ⭐ (更新 - Rust 版)

**本地代理功能** (DoraMate LocalAgent - Rust):
- 调用 `dora run` 在本地运行数据流
- 调用 `dora build` 安装依赖
- 进程生命周期管理（启动/停止/监控）
- 实时日志收集和推送
- 硬件资源检测和冲突处理
- 系统托盘集成

**前端集成** (Leptos WebAssembly):
- `DoraRunner` Trait - 与本地代理通信
- `LocalDoraRunner` 实现 - HTTP 调用 localhost:52100
- 自动检测本地代理状态
- 本地代理安装引导对话框
- 实时日志显示组件

**实时监控** (WebSockets):
- WebSocket 实时推送日志
- 节点状态更新
- 错误通知

### 4. 文件系统管理 ⭐ (核心功能)

**文件操作**:
- 打开/保存 YAML 文件
- 最近文件列表
- 文件夹浏览
- 拖拽打开文件
- 自动备份

**缓存管理**:
- 节点元数据缓存 (JSON)
- 缩略图生成
- 缓存清理机制

**配置管理**:
- 用户偏好设置 (TOML)
- 编辑器配置
- 主题设置

### 5. 数据验证系统

**前端验证**:
- 实时表单验证
- 连线类型检查
- 节点配置验证

**后端验证**:
- Validator 声明式验证
- 调用 dora-daemon 验证 API
- 深度数据流验证

---

## 数据存储架构 ⭐

### 纯文件系统目录结构

```
~/.doramate/                          # DoraMate 数据根目录
│
├── dataflows/                        # 数据流 YAML 文件 ⭐
│   ├── vision/                       # 按类别组织
│   │   ├── camera-capture.yml
│   │   ├── yolo-detection.yml
│   │   └── sam2-segmentation.yml
│   ├── audio/                        # 音频处理流
│   │   └── speech-recognition.yml
│   └── robotics/                     # 机器人控制流
│       └── arm-control.yml
│
├── cache/                            # 缓存文件
│   ├── nodes.json                    # 节点元数据缓存
│   │   # {
│   │   #   "version": "2025.01.15",
│   │   #   "nodes": {
│   │   #     "camera": { ... },
│   │   #     "yolo": { ... }
│   │   #   }
│   │   # }
│   │
│   ├── thumbnails/                   # 缩略图缓存
│   │   └── *.svg
│   │
│   └── index.json                    # 文件索引 (可选，用于搜索)
│       # {
│       #   "dataflows": [
│       #     { "path": "vision/camera.yml", "name": "...", "tags": [] }
│       #   ]
│       # }
│
├── recent.json                       # 最近打开文件列表 ⭐
│   # {
│   #   "recent": [
│   #     { "path": "~/projects/flow.yml", "opened_at": "2025-01-21T10:00:00Z" },
│   #     { "path": "~/.doramate/dataflows/test.yml", "opened_at": "2025-01-21T09:30:00Z" }
│   #   ]
│   # }
│
├── config.toml                       # 用户配置 ⭐
│   # [editor]
│   # theme = "dark"
│   # auto_save = true
│   # auto_save_interval = 60
│   #
│   # [canvas]
│   # grid_enabled = true
│   # snap_to_grid = true
│   #
│   # [runtime]
│   # dora_path = "/usr/bin/dora"
│   # log_level = "info"
│
├── templates/                        # 数据流模板 (可选)
│   ├── basic-camera.yml
│   └── advanced-vision.yml
│
├── backups/                          # 自动备份 (可选)
│   └── 2025-01-21/
│       └── flow_103000.yml
│
└── logs/                             # 日志文件
    ├── doramate.log
    └── local-agent.log
```

### 文件格式规范

**数据流 YAML 文件** (兼容 DORA):
```yaml
# ~/.doramate/dataflows/my-flow.yml

# DoraMate 扩展元数据 (可选)
__doramate__:
  name: "My Camera Flow"
  description: "Camera capture with YOLO detection"
  tags: [vision, yolo]
  created_at: "2025-01-21T10:00:00Z"
  modified_at: "2025-01-21T11:30:00Z"

# 标准 DORA 数据流定义
nodes:
  camera:
    id: camera
    source: ../nodes/camera-opencv
    inputs:
      timer:
        source: dora/timer/millis/30
        interval: 30

  yolo:
    id: yolo
    source: ../nodes/yolov8
    inputs:
      image:
        source: camera
        queue_size: 10

# ... 更多节点配置
```

**节点缓存 JSON**:
```json
{
  "version": "2025.01.15",
  "last_sync": "2025-01-21T10:00:00Z",
  "categories": {
    "input": [
      {
        "id": "camera",
        "name": "Camera (OpenCV)",
        "description": "Camera capture node",
        "source": "dora-camera-opencv",
        "language": "Python",
        "inputs": { "timer": "dora/timer/millis/{interval}" },
        "outputs": { "image": "ArrowArray" }
      }
    ],
    "process": [
      {
        "id": "yolo",
        "name": "YOLOv8 Object Detection",
        "description": "YOLO object detection",
        "source": "dora-yolov8",
        "language": "Python"
      }
    ]
  }
}
```

**配置 TOML**:
```toml
[editor]
theme = "dark"              # dark | light
auto_save = true
auto_save_interval = 60     # seconds
font_size = 14
font_family = "JetBrains Mono"

[canvas]
grid_enabled = true
grid_size = 20
snap_to_grid = true
zoom_sensitivity = 1.2

[files]
default_folder = "~/.doramate/dataflows"
show_hidden = false
auto_backup = true
backup_count = 10

[runtime]
dora_path = "/usr/bin/dora"  # or "C:\Program Files\DORA\dora.exe"
log_level = "info"           # debug | info | warn | error
max_log_size = 10485760      # 10MB

[proxy]
enabled = true
host = "localhost"
port = 52100
```

### 文件操作 API 设计

```rust
// src/filesystem/mod.rs

use std::path::{Path, PathBuf};
use tokio::fs;

/// 文件系统管理器
pub struct FileSystemManager {
    base_dir: PathBuf,
    recent_files: RecentFiles,
    config: Config,
}

impl FileSystemManager {
    /// 打开数据流文件
    pub async fn open_dataflow(&self, path: &Path) -> Result<Dataflow, IoError> {
        let content = fs::read_to_string(path).await?;
        let dataflow: Dataflow = serde_yaml::from_str(&content)?;
        self.add_to_recent(path).await?;
        Ok(dataflow)
    }

    /// 保存数据流文件
    pub async fn save_dataflow(&self, path: &Path, dataflow: &Dataflow) -> Result<(), IoError> {
        // 自动备份
        if self.config.auto_backup {
            self.create_backup(path).await?;
        }

        // 序列化为 YAML
        let yaml = serde_yaml::to_string(dataflow)?;

        // 写入文件
        fs::write(path, yaml).await?;

        // 更新最近文件
        self.add_to_recent(path).await?;

        Ok(())
    }

    /// 获取最近文件列表
    pub async fn recent_files(&self) -> Vec<PathBuf> {
        self.recent_files.list()
    }

    /// 扫描数据流文件夹
    pub async fn scan_dataflows(&self) -> Vec<DataflowInfo> {
        let mut dataflows = Vec::new();
        let entries = fs::read_dir(&self.base_dir).await.unwrap();

        while let Some(entry) = entries.next_entry().await.unwrap() {
            if entry.path().extension().unwrap_or_default() == "yml" {
                // 读取元数据
                if let Ok(info) = self.parse_dataflow_info(&entry.path()).await {
                    dataflows.push(info);
                }
            }
        }

        dataflows
    }

    /// 清理缓存
    pub async fn clear_cache(&self) -> Result<(), IoError> {
        let cache_dir = self.base_dir.join("cache");
        fs::remove_dir_all(&cache_dir).await?;
        fs::create_dir(&cache_dir).await?;
        Ok(())
    }
}

/// 最近文件管理
struct RecentFiles {
    file: PathBuf,
    entries: Vec<RecentEntry>,
}

#[derive(serde::Serialize, serde::Deserialize)]
struct RecentEntry {
    path: PathBuf,
    opened_at: chrono::DateTime<chrono::Utc>,
}
```

---

## 用户操作业务流程

### 主要业务流程图

```
┌──────────────────────────────────────────────────────────────┐
│                     用户使用主流程                             │
└──────────────────────────────────────────────────────────────┘

1. 创建数据流流程
   ┌──────────┐
   │ 点击新建 │
   │ 数据流   │
   └────┬─────┘
        │
        ▼
   ┌──────────────┐
   │ 从节点面板    │
   │ 拖拽节点到画布│
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 连接节点端口  │
   │ 建立数据流    │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 编辑节点属性  │
   │ 配置参数      │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 点击保存     │
   │ 选择保存位置  │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 保存为 .yml  │
   │ 文件         │
   └──────────────┘

2. 打开现有数据流 ⭐ (文件系统)
   ┌──────────┐
   │点击打开  │
   │ 按钮     │
   └────┬─────┘
        │
        ▼
   ┌──────────────┐
   │ 显示文件     │
   │ 选择对话框   │
   └──────┬───────┘
          │
     ┌────┴────┐
     │         │
     ▼         ▼
  [从最近文件] [浏览文件夹]
     │         │
     └────┬────┘
          ▼
   ┌──────────────┐
   │ 读取 YAML    │
   │ 文件内容     │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 解析并渲染   │
   │ 可视化图     │
   └──────────────┘

3. YAML 导入流程（独有功能）
   ┌──────────┐
   │点击导入  │
   │ YAML 按钮│
   └────┬─────┘
        │
        ▼
   ┌──────────────┐
   │ 选择 .yml    │
   │ 文件         │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 系统自动解析  │
   │ 和布局节点    │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 可视化展示    │
   │ 拓扑结构      │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 可选择编辑    │
   │ 或直接运行    │
   └──────────────┘

4. 本地运行数据流流程 ⭐ (更新 - Rust 版)
   ┌──────────┐
   │ 点击本地  │
   │ 运行按钮  │
   └────┬─────┘
        │
        ▼
   ┌──────────────┐
   │ 检查本地代理 │
   │ 是否安装     │
   └──────┬───────┘
          │
     ┌────┴────┐
     │         │
     ▼         ▼
  [已安装]  [未安装]
     │         │
     │         ▼
     │    ┌─────────┐
     │    │ 显示安装 │
     │    │ 引导对话框│
     │    └─────────┘
     │
     ▼
   ┌──────────────┐
   │ 前端生成     │
   │ YAML 配置    │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 调用本地代理 │
   │ localhost:   │
   │ 52100/api/run│
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 本地代理执行 │
   │ dora build  │
   │ dora run    │
   │ (tokio::process)│
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 节点进程     │
   │ 本地启动     │
   │ - camera    │
   │ - yolo      │
   │ - sam2      │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 实时日志     │
   │ 推送到浏览器 │
   │ (WebSocket) │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 可随时停止   │
   │ 本地数据流   │
   └──────────────┘

5. 导出 YAML 流程
   ┌──────────┐
   │ 点击导出 │
   │ YAML 按钮│
   └────┬─────┘
        │
        ▼
   ┌──────────────┐
   │ 前端生成     │
   │ YAML 内容    │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 浏览器下载   │
   │ .yml 文件    │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ 可用 dora-cli│
   │ 直接运行     │
   └──────────────┘
```

### 典型使用场景

**场景 1：从零创建数据流** ⭐ (更新)
1. 打开 DoraMate，点击"新建数据流"
2. 从左侧节点面板拖拽所需节点到画布
3. 连接节点的输入输出端口
4. 点击节点编辑属性（path、env、inputs 等）
5. 点击"验证"检查配置
6. 点击"保存"，选择保存位置（默认: ~/.doramate/dataflows/）
7. 点击"本地运行"⭐ 启动数据流
8. 首次运行会提示安装本地代理服务
9. 本地执行数据流，实时查看日志和节点状态

**场景 2：打开并编辑现有数据流** ⭐ (文件系统)
1. 点击"打开"按钮
2. 从最近文件列表选择，或浏览文件夹
3. 系统读取 YAML 文件并可视化展示
4. 拖拽调整布局或修改节点配置
5. 点击"保存"更新文件
6. 可选：自动备份原文件

**场景 3：导入并优化现有数据流**
1. 点击"导入 YAML"按钮
2. 选择现有的 dataflow.yml 文件
3. 系统自动解析并生成可视化拓扑图
4. 查看节点连接关系
5. 拖拽调整布局或删除冗余节点
6. 保存为新文件或覆盖原文件

**场景 4：学习他人数据流**
1. 从 GitHub 下载示例 YAML
2. 拖拽文件到 DoraMate 窗口
3. 可视化查看节点连接和数据流向
4. 理解数据流逻辑
5. 基于示例修改创建自己的数据流
6. 另存为新文件

---

## 开发计划概览

### 6个月 MVP 路线图

**阶段一: 基础架构搭建 (第1-2月)**

第1个月 - 开发环境与基础框架:
- ✅ Rust 工具链安装 (rustup、cargo)
- ✅ Leptos 项目脚手架 (cargo-leptos)
- ✅ Axum Web API 搭建
- ✅ 文件系统模块设计 ⭐
- ✅ Trunk 构建配置

第2个月 - 核心数据模型与画布:
- ✅ 节点数据模型设计 (Struct + Enums)
- ✅ 基础画布组件（SVG + Leptos）
- ✅ YAML 序列化/反序列化 (serde_yaml) ⭐
- ✅ 文件打开/保存功能 ⭐
- ✅ DORA CLI 调用封装 (tokio::process)
- ✅ Docker 开发环境

**阶段二: 核心功能开发 (第3-4月)**

第3个月 - 可视化编辑器:
- ✅ 节点面板组件
- ✅ 属性面板组件
- ✅ 连线功能增强
- ✅ 数据验证逻辑
- ✅ 工具栏功能 (打开、保存、最近文件) ⭐

第4个月 - DORA 集成:
- ✅ WebSocket 实时日志
- ✅ 数据流运行功能
- ✅ 节点状态监控
- ✅ 撤销重做功能
- ✅ 错误处理与提示

**阶段三: 优化与推广 (第5-6月)**

第5个月 - 性能优化:
- ✅ 性能优化（虚拟滚动、懒加载）
- ✅ UI/UX 优化
- ✅ 单元测试（覆盖率 > 80%）
- ✅ E2E 测试
- ✅ 文档与教程

第6个月 - 发布推广:
- ✅ 官网集成
- ✅ 营销内容（15+ 技术博客、演示视频）
- ✅ 社区建设（微信群、种子用户）
- ✅ GitHub Release v1.0

**阶段四: 工业级组件库构建 (第7-12月, 可选)**

第7-9月 - 工业级 UI 组件库:
- ✅ 数据表格组件 (虚拟滚动、10万+ 行)
- ✅ 表单系统 (动态验证)
- ✅ 图表组件 (实时数据可视化)
- ✅ 树形控件、属性面板、文件浏览器 ⭐

第10-12月 - 为 ERP/MES 迁移准备:
- ✅ 组件库文档和示例
- ✅ 性能基准测试
- ✅ 稳定性测试 (7x24 运行)

### 里程碑

| 月份 | 阶段 | 交付物 | 里程碑 |
|-----|------|--------|--------|
| 1 | 基础架构 | 开发环境 | 环境就绪 |
| 2 | 基础架构 | 基础画布 + 文件操作 ⭐ | 可拖拽节点、可打开/保存 |
| 3 | 核心功能 | 完整编辑器 | 可创建数据流 |
| 4 | 核心功能 | DORA 集成 | v0.5.0-alpha |
| 5 | 优化推广 | 性能优化 | 测试覆盖率 > 80% |
| 6 | 优化推广 | 正式发布 | v1.0 正式版 |
| 7-9 | 组件库 | 工业级 UI 库 | 可复用组件库 v0.1 |
| 10-12 | 系统迁移 | ERP/MES 迁移准备 | 技术栈验证完成 |

---

## 验收标准

### MVP 功能验收

**必须功能 (P0)**:
- ✅ 可视化节点编辑器正常工作（拖拽、连接、移动、删除）
- ✅ 支持至少 20 个常用 DORA 节点
- ✅ 导出的 YAML 可被 dora-cli 正确运行
- ✅ 实时验证错误和警告
- ✅ 在线运行数据流并查看日志
- ✅ 响应式设计，支持主流浏览器
- ✅ 打开/保存 YAML 文件 ⭐
- ✅ 最近文件列表 ⭐

**应该功能 (P1)**:
- ⚠️ 撤销重做功能
- ⚠️ YAML 导入功能（独有）
- ⚠️ 自动保存功能 ⭐
- ⚠️ 数据流模板库

### 性能指标

**画布渲染性能**:
- 50+ 节点流畅运行 (60fps)
- 渲染延迟 < 16ms

**加载性能**:
- 首屏加载 < 2 秒 ⭐ (WASM 优势 + 无数据库初始化)
- 首次绘制 (FP) < 500ms ⭐
- 可交互时间 (TTI) < 2 秒 ⭐

**文件操作性能** ⭐:
- 打开文件 < 100ms (YAML 解析)
- 保存文件 < 50ms (序列化 + 写入)
- 扫描文件夹 < 500ms (100个文件)

**资源占用**:
- 浏览器内存 < 100MB ⭐ (无 GC 开销)
- WASM Bundle 大小 < 1.5MB (gzipped) ⭐
- 网络传输 < 400KB (首屏) ⭐
- 磁盘占用 < 50MB (纯文件系统) ⭐

### 稳定性指标 (工业级) ⭐

**7x24 运行稳定性**:
- MTBF (平均故障间隔): > 720小时 (30天) ⭐
- MTTR (平均修复时间): < 5分钟
- 内存泄漏: 0 ⭐ (Rust 保证)
- 句柄泄漏: 0
- 可连续运行: > 6个月 ⭐

**性能一致性**:
- 无 GC 停顿 ⭐
- 确定性内存管理 ⭐
- 长期运行无性能下降 ⭐

**文件系统稳定性** ⭐:
- 文件损坏率: 0 (原子写入)
- 数据丢失率: 0 (自动备份)
- 并发访问安全: ✅ (文件锁)

### 用户体验指标

**易用性指标**:
- 📊 新手 5 分钟内创建第一个数据流
- 📊 交互反馈延迟 < 100ms
- 📊 错误提示准确率 > 95%

**满意度指标**:
- 📊 用户满意度 > 4.5/5.0
- 📊 任务完成率 > 90%
- 📊 学习曲线 < 30 分钟

### 业务指标（v1.0 发布时）

- 📊 日活用户 (DAU): 50+
- 📊 数据流创建数: 100+
- 📊 数据流运行数: 50+
- 📊 平均使用时长: 10 分钟+

---

## 核心优势总结

### 与传统 DORA 开发对比

| 功能 | 传统 DORA | DoraMate | 提升 |
|------|----------|----------|------|
| 数据流创建 | 手写 YAML | 拖拽节点 | 5x 效率 |
| 节点连接 | 手动配置 | 自动连线 | 10x 效率 |
| 错误排查 | 运行时报错 | 实时验证 | 3x 效率 |
| 学习曲线 | 陡峭 | 平缓 | -70% 时间 |

### YAML 可视化功能优势（独有）

| 功能 | 传统方式 | DoraMate YAML 可视化 |
|------|---------|---------------------|
| 理解数据流 | 需要阅读整个 YAML 文件 | 一目了然的拓扑图 |
| 发现连接错误 | 手动追踪输入输出 | 自动高亮错误连接 |
| 优化结构 | 需要重新理解整个文件 | 拖拽即可调整 |
| 学习曲线 | 陡峭 | 平缓 |

### 技术优势 (Rust 版 + 纯文件系统) ⭐

1. **全栈 Rust**: 前后端统一语言，代码复用最大化
2. **类型安全**: 编译时检查，零运行时类型错误
3. **高性能**: Leptos 细粒度响应式 + WASM 原生性能
4. **工业级稳定性**: 无 GC 停顿，可连续运行数年
5. **内存安全**: Rust 编译器保证，无内存泄漏
6. **YAML 自动布局**: 层次化布局算法，自动优化拓扑结构
7. **可复用组件库**: 为 ERP/MES/PLC 系统迁移奠定基础
8. **零数据库**: 简化架构、零配置、零依赖 ⭐
9. **纯文件系统**: 符合 Unix 哲学、易于备份、易于理解 ⭐

### 本地执行架构优势 ⭐ (更新)

| 特性 | 服务器执行 | 本地执行 | 提升 |
|-----|----------|---------|------|
| **硬件访问** | ❌ 受限（共享硬件） | ✅ 完全访问（独占） | ∞ |
| **隐私保护** | ⚠️ 中等（数据上传） | ✅ 高（数据本地） | ↑↑ |
| **网络延迟** | 50-200ms | 0ms | ∞ |
| **GPU 利用** | 共享，受限 | 独占100% | 10x |
| **多用户隔离** | 需要容器化 | 自然隔离 | ✓ |
| **离线工作** | ❌ 不支持 | ✅ 完全支持 | ✓ |
| **服务器成本** | ¥10,000/月 | ¥350/月 | -96% |
| **开发复杂度** | 高（资源调度） | 低（用户自管） | ↓ |
| **稳定性** | ⭐⭐⭐ (GC 停顿) | ⭐⭐⭐⭐⭐ (无 GC) | ↑↑ |
| **数据库维护** | 需要 PostgreSQL | ❌ 不需要 ⭐ | -100% ⭐ |

**核心价值**:
- ✅ **解决硬件冲突**: 每个用户独立使用本地硬件，无冲突
- ✅ **隐私保护**: 视频流、敏感数据不离开本地机器
- ✅ **性能优越**: 零网络延迟，充分利用本地 GPU
- ✅ **离线工作**: 无需互联网连接即可运行
- ✅ **成本节省**: 服务器成本降低 96%+
- ✅ **工业级稳定性**: Rust 无 GC，可 7x24 连续运行数年 ⭐
- ✅ **零维护成本**: 无数据库配置、备份、迁移 ⭐
- ✅ **简化开发**: 专注核心功能，加速 MVP ⭐

### 长期战略价值 ⭐ (工业软件迁移)

**第一次 (DoraMate)**:
- 学习 Leptos + WASM: 2个月
- 构建工业级 UI 组件库: 2个月
- 开发 DoraMate: 2个月
- **总计**: 6个月

**后续迁移 (5大系统)**:
- ERP: 复用组件库 → 3个月
- OA: 复用组件库 → 2个月
- MES: 复用组件库 → 4个月
- PLC 系统: 复用组件库 → 3个月
- 生产调度: 复用组件库 → 3个月

**节省时间**: 15个月 vs 25个月 (如果每次都学)
**投资回报率**: 10倍以上!

---

## 技术亮点

### ⭐ YAML 自动布局算法

**核心特性**:
- 基于拓扑排序的层次化布局
- 交叉最小化算法
- 自动计算节点位置
- 支持手动调整位置

**应用场景**:
- 导入现有 YAML 文件时自动布局
- 一键整理杂乱的画布
- 优化节点连接结构

### ⭐ WebSocket 实时通信 (Rust 版)

**核心特性**:
- 基于 Axum + tokio-tungstenite
- 类型安全、异步 I/O
- 自动重连机制
- 实时推送日志和状态
- 零拷贝性能优势

### ⭐ Leptos 组件化架构

**核心特性**:
- 全栈 Rust 开发
- 细粒度响应式系统 (Signals)
- 组件复用性强
- 编译为 WebAssembly
- 类型安全保证

### ⭐ 纯文件系统架构 ⭐

**核心特性**:
- 零配置、零依赖
- 符合 Unix 哲学："一切皆文件"
- 易于备份、易于迁移
- YAML 人性化、可读性强
- 无数据库维护成本
- 专注核心功能开发

### ⭐ 工业级性能与稳定性 ⭐

**核心特性**:
- 无 GC 停顿: 确定性内存管理
- 内存安全: 编译时保证，无运行时恐慌
- 零拷贝: WASM 与 JS 之间高效通信
- 虚拟滚动: 10万+ 行流畅渲染
- 长期运行: 可连续运行数年无需重启

---

## 项目成功标准

### MVP 成功标志

当满足以下条件时，视为 MVP 成功：
- ✅ 10 个种子用户能独立使用
- ✅ 成功运行 5 个真实数据流
- ✅ 用户满意度 > 4.5/5.0
- ✅ 性能指标全部达标
- ✅ 稳定性测试通过 (连续运行 30 天无故障) ⭐
- ✅ 文件操作测试通过 (1000+ 次打开/保存无损坏) ⭐

### 长期愿景

- 🚀 成为 DORA 生态的标准可视化工具
- 🚀 降低具身智能开发门槛，促进 AI 普及
- 🚀 建立活跃的开发者社区
- 🚀 支持更多 AI 框架和硬件平台
- 🚀 构建 Rust 工业软件技术栈，迁移 5 大系统 ⭐

---

## 附录

### 关键技术决策

1. **为什么选择 Rust + Leptos 而不是 Blazor/React?** ⭐
   - 工业级稳定性需求: 无 GC 停顿，可 7x24 连续运行
   - 性能优势: WebAssembly 原生支持，零成本抽象
   - 长期价值: 构建可复用 UI 组件库
   - 技术壁垒: 工业软件领域 Rust 技术的先发优势
   - 市场机会: 工业软件市场 Rust 方案几乎空白

2. **为什么选择本地执行而不是服务器执行？** ⭐
   - 完全解决硬件冲突问题（摄像头、GPU）
   - 隐私保护，敏感数据不上传
   - 性能优越，零网络延迟
   - 服务器成本降低 96%+
   - 多用户自然隔离，无需复杂调度

3. **为什么选择纯文件系统而不是数据库？** ⭐ (新增)
   - 零配置: 无需数据库安装、配置、维护
   - 零依赖: 减少 SeaORM、数据库驱动等复杂依赖
   - 简化开发: 专注核心功能，加速 MVP
   - 易于备份: 直接复制文件夹即可
   - 符合 DORA 哲学: YAML 即配置
   - 人性化: YAML 文件可读、可编辑、可版本控制
   - 降低学习曲线: 文件系统比数据库更直观

4. **为什么通过进程调用 dora-cli 而不是重新实现?**
   - 复用现有稳定工具
   - 与 DORA CLI 100% 兼容
   - 专注可视化编辑体验

5. **为什么选择 Leptos 而不是其他 Rust WASM 框架?** ⭐
   - 细粒度响应式系统 (类似 Solid.js)
   - 编译时优化、运行时开销最小
   - 类似 React 的开发体验
   - 社区活跃、文档完善

### 技术风险与应对

**风险 1**: Leptos WebAssembly 性能
- **应对**: 虚拟滚动、懒加载、代码分割、细粒度更新

**风险 2**: 大型数据流渲染
- **应对**: Canvas 渲染优化、节点虚拟化、Web Workers

**风险 3**: DORA API 变更
- **应对**: 版本隔离、适配器模式、Trait 抽象

**风险 4**: Rust 学习曲线 ⭐
- **应对**: 6个月专注学习、构建可复用组件库、长期价值

**风险 5**: 工业级 UI 组件库复杂度 ⭐
- **应对**: 分阶段实现、先核心后扩展、复用 DoraMate 经验

**风险 6**: 文件系统并发访问 ⭐ (新增)
- **应对**: 文件锁、原子写入、自动备份

**风险 7**: 大规模文件管理 ⭐ (新增)
- **应对**: 文件索引、智能缓存、懒加载

---

**文档版本**: v4.0 ⭐ (Rust 全栈 + 纯文件系统)
**最后更新**: 2025-01-21
**基于章节**: 01-14 完整技术实现路径分析 + Rust 技术栈 + 零数据库架构
**作者**: 夏豪

**更新内容**:
- ✅ 替换为全 Rust 技术栈 (Leptos + Axum)
- ✅ 采用纯文件系统架构，移除所有数据库相关内容 ⭐
- ✅ 新增文件系统目录结构设计 ⭐
- ✅ 新增文件操作 API 设计 ⭐
- ✅ 新增工业级稳定性要求 (7x24 无故障运行)
- ✅ 新增可复用 UI 组件库战略价值
- ✅ 更新技术栈选型和对比分析
- ✅ 增加长期战略规划 (ERP/MES/PLC 迁移)
- ✅ 强化性能和稳定性指标
- ✅ 新增 Rust 生态工具链说明

---

## 快速导航

- 详细架构设计 → [05 - Leptos 前端架构](./05-Leptos前端架构.md) ⭐
- 本地执行架构 → [14 - 本地执行架构设计](./14-本地执行架构设计.md) ⭐
- 后端架构设计 → [06 - Axum后端架构](./06-Axum后端架构.md) ⭐
- 文件系统设计 → [07 - 文件系统架构](./07-文件系统架构.md) ⭐ (新增)
- YAML 可视化功能 → [10 - YAML 可视化功能](./10-YAML可视化功能.md)
- 开发计划 → [11 - MVP 开发计划](./11-MVP开发计划.md)
- 数据模型 → [12 - 数据模型设计](./12-数据模型设计.md)
- 验收标准 → [13 - 验收标准](./13-验收标准.md)
- 工业级 UI 组件库 → [15 - 工业级UI组件库设计](./15-工业级UI组件库设计.md) ⭐
- 系统迁移规划 → [16 - 系统迁移规划](./16-系统迁移规划.md) ⭐
